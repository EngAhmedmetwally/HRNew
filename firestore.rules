
rules_version = '2';

/**
 * @name HR Pulse Firestore Security Rules
 * @author Firebase App Builder
 *
 * @description
 * This ruleset enforces a Role-Based Access Control (RBAC) model combined with
 * a strict user-ownership model for an HR management application. The security
 * is designed to be robust and flexible for rapid prototyping, focusing on
 * authorization without enforcing strict data schemas.
 *
 * @philosophy
 * Core Philosophy: The security model defines three primary roles:
 * 1. Admin: Super-user with full read/write access to all data, including role management. Identified by existence in /roles_admin collection.
 * 2. HR: Can manage employee records, attendance, and payroll. Identified by existence in /roles_hr collection.
 * 3. Employee: Can only read/write their own personal data (profile, attendance, payroll).
 *
 * All access requires user authentication.
 *
 * @structure
 * Data Structure: Data is organized into top-level collections.
 * - /employees/{employeeId}: Core employee profiles. The document ID {employeeId} MUST match the auth UID.
 * - /workDays: All employee attendance data, keyed by a unique workDayId. Ownership is checked via the `employeeId` field in the document.
 * - /payrolls: Employee-specific data, logically partitioned by date and keyed by employeeId in the path for direct ownership checks.
 * - /deductionPolicies & /settings: System-wide configuration, readable by all authenticated users, writable only by Admins.
 * - /roles_admin & /roles_hr: Collections that define user roles. Document existence grants the role.
 *
 * @decisions
 * Key Security Decisions:
 * - Role-Based Access: Uses `exists()` checks against the /roles_admin and /roles_hr collections for performant and clear permissioning.
 * - Strict Ownership: An employee's access to their own data is enforced using the `employeeId` in the document path or field, assuming it matches their authentication UID.
 * - Segregated Listing: To prevent data leaks, `list` operations on collections containing mixed private data are restricted to Admin/HR roles. Employees can only `get` their specific documents.
 * - Immutable Ownership Links: Once an employee-specific record (like a payroll or workday) is created, its link to the employee (the `employeeId` field) cannot be changed.
 * - Default Deny: All operations are denied by default unless explicitly allowed. Unauthenticated access is completely blocked.
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user has an Admin role.
     * An Admin user is defined by the existence of their UID in the /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Checks if the currently authenticated user has an HR role.
     * An HR user is defined by the existence of their UID in the /roles_hr collection.
     */
    function isHr() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_hr/$(request.auth.uid));
    }

    /**
     * Checks if the user is either an HR user or an Admin.
     * An Admin is implicitly an HR user.
     */
    function isHrOrAdmin() {
      return isAdmin() || isHr();
    }


    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the core of the document ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Manages core employee profiles. Employees can read and update their own profile.
     *   HR and Admins can manage all employee profiles.
     * @path /employees/{employeeId}
     * @allow (get) An employee with UID 'emp123' reads '/employees/emp123'.
     * @allow (update) An employee 'emp123' updates their own device ID in '/employees/emp123'.
     * @deny (list) An employee tries to list all documents in the '/employees' collection.
     * @deny (update) An employee 'emp123' tries to update their own salary in '/employees/emp123' (if restricted by fields).
     * @principle Enforces document ownership for reads/self-writes and role-based access for admin writes.
     */
    match /employees/{employeeId} {
      allow get: if isOwner(employeeId) || isHrOrAdmin();
      allow list: if isHrOrAdmin();
      allow create: if isHrOrAdmin();
      allow update: if isHrOrAdmin() || isOwner(employeeId);
      allow delete: if isHrOrAdmin() && resource != null;
    }

    /**
     * @description Stores daily attendance records. Employees can create and read their own records.
     * HR and Admins have full control. Listing is restricted to HR/Admin roles.
     * @path /workDays/{workDayId}
     * @allow (get) An employee reads their own attendance for a specific day.
     * @allow (create) An employee creates their own attendance record.
     * @deny (update) An employee tries to modify a past attendance record.
     * @deny (list) An employee tries to list all attendance for a given day.
     * @principle Restricts access to a user's own data and allows self-creation of records.
     */
    match /workDays/{workDayId} {
      allow get: if isHrOrAdmin() || (isSignedIn() && resource.data.employeeId == request.auth.uid);
      allow list: if isHrOrAdmin();
      allow create: if isHrOrAdmin() || (isSignedIn() && request.resource.data.employeeId == request.auth.uid);
      allow update: if isHrOrAdmin() && request.resource.data.employeeId == resource.data.employeeId;
      allow delete: if isHrOrAdmin();
    }


    /**
     * @description Manages global deduction policies. Readable by authenticated users, writable by Admins.
     * @path /deductionPolicies/{deductionPolicyId}
     * @allow (get, list) Any authenticated employee or HR user reads the policies.
     * @deny (create) An HR user tries to create a new company-wide deduction policy.
     * @principle Provides public read access for configuration data while securing writes to admin-level roles.
     */
    match /deductionPolicies/{deductionPolicyId} {
       allow get, list: if isSignedIn();
       allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Manages global system settings. Readable by authenticated users, writable by Admins.
     * @path /settings/{docId}
     * @allow (get) An authenticated employee reads settings for attendance checks.
     * @deny (update) An HR user tries to change the QR code refresh rate.
     * @principle Allows necessary read access for all users while protecting modifications.
     */
    match /settings/{docId} {
      allow get: if isSignedIn();
      allow list, create, update, delete: if isAdmin();
    }

    /**
     * @description Stores sensitive monthly payroll records. An employee can only read their own record.
     *   Creation and modification are restricted to HR and Admins.
     * @path /payrolls/{payrollId}
     * @allow (get) Employee 'emp123' reads their own payroll for a given month.
     * @deny (update) Employee 'emp123' tries to modify their own payroll document.
     * @deny (list) Employee 'emp123' tries to list all payrolls for a given month.
     * @principle Enforces strict ownership for highly sensitive data, with write access limited to privileged roles.
     */
    match /payrolls/{payrollId} {
      allow get: if isHrOrAdmin() || (isSignedIn() && resource.data.employeeId == request.auth.uid);
      allow list: if isHrOrAdmin();
      allow create: if isHrOrAdmin();
      allow update: if isHrOrAdmin() && resource != null && request.resource.data.employeeId == resource.data.employeeId;
      allow delete: if isHrOrAdmin() && resource != null;
    }

    /**
     * @description Manages temporary QR codes for attendance. Readable by any signed-in user for verification.
     *   Managed exclusively by HR and Admins.
     * @path /qrCodes/{qrCodeId}
     * @allow (get) An employee's device reads a QR code to verify it.
     * @deny (create) A regular employee tries to generate their own QR code.
     * @principle Allows necessary read access for the core attendance feature to work, while securing management.
     */
    match /qrCodes/{qrCodeId} {
      allow get: if isSignedIn();
      allow list, create, update, delete: if isHrOrAdmin();
    }

    /**
     * @description Defines which users are Admins. Only other Admins can manage this list.
     * @path /roles_admin/{uid}
     */
    match /roles_admin/{uid} {
      allow get: if isSignedIn();
      allow list, create, update, delete: if isAdmin();
    }

    /**
     * @description Defines which users are HR personnel. Only Admins can manage this list.
     * @path /roles_hr/{uid}
     * @allow (create) An Admin grants HR privileges to a user.
     * @deny (create) An HR user tries to grant HR privileges to another user.
     * @principle Enforces separation of duties; role management is an Admin-only function.
     */
    match /roles_hr/{uid} {
      allow get, list: if isHrOrAdmin();
      allow create, update, delete: if isAdmin();
    }
  }
}
